\documentclass[11pt,a4paper]{memoir}

%%%% GENERAL PACKAGES FORMATTING %%%%%

\usepackage[bookmarks, pdfauthor={臺灣植物紅皮書編輯委員會}, pdftitle={2017 臺灣維管束植物紅皮書名錄}]{hyperref}
\usepackage{amsmath,amsthm,amssymb} % for mathematical fonts
\usepackage{bold-extra}
\usepackage{caption}
\usepackage{doi}
\usepackage{enumitem}
\usepackage{epstopdf}   % figure eps to pdf
\usepackage{float}      % floating environment
\usepackage{graphicx}
\usepackage{natbib}     % for bibliography style%\usepackage{apalike}
\usepackage{apalike} % apalike
\usepackage{longtable}  % small capital
\usepackage{libertine}
% multi column
\usepackage{multicol}
\usepackage{footnote}
\usepackage{setspace} 
\usepackage{pdfpages} % pdfpage
\usepackage{xcolor}
\usepackage{color}

%%%%% <XETEX> %%%%%
\usepackage{fontspec}
\usepackage{xeCJK}
%\setmainfont{Noto Serif CJK TC Light}
%\setCJKmainfont{Songti TC}
\setCJKmainfont{Songti TC Light}
\newCJKfontfamily\Kai{Noto Sans T Chinese Light}
\newCJKfontfamily\Song{Noto Sans T Chinese Regular}
\newCJKfontfamily\Hangul{Batang}
\newCJKfontfamily\Kana{YuMincho}
\XeTeXlinebreaklocale "zh"
\XeTeXlinebreakskip = 0pt plus 1pt
\setlength{\parskip}{0.3cm}
\setmonofont[WordSpace={0.7,0.0,0.0}]{Courier}
\usepackage{xltxtra}
\renewcommand{\thepage}{\footnotesize{\arabic{page}}}
\linespread{1.2}\selectfont % 字型間距
\setlength\columnsep{18pt} % 兩欄之間的空隙
%%%%% </XETEX> %%%%%

%%%%% HEADER STYLE %%%%%%
\copypagestyle{memoirStylePages}{headings}
\nouppercaseheads
\copypagestyle{memoirStylePages}{headings}
\copypagestyle{chapter}{headings}
\copypagestyle{chapter*}{headings}
\setlength{\headwidth}{\stockwidth+5em}
\makerunningwidth{memoirStylePages}{\headwidth}
\definecolor{mydarkgrey}{RGB}{102,100,100}
\definecolor{mylightgrey}{RGB}{220,221,221}
\definecolor{myred}{RGB}{230,0,18}
\definecolor{mylightred}{RGB}{251,218,200}
\definecolor{myorange}{RGB}{243,151,0}
\definecolor{mylightorange}{RGB}{255,236,210}
\definecolor{myyellow}{RGB}{255,226,0}
\definecolor{mylightyellow}{RGB}{255,250,222}
\definecolor{mygreen}{RGB}{219,224,0}
\definecolor{mylightgreen}{RGB}{249,249,218}


\newcommand\frameboxl[1]{%
  \fcolorbox{red}{red}{\makebox[2cm][l]{\textcolor{white}{\bfseries#1}}}%
}

\newcommand\frameboxr[1]{%
  \fcolorbox{red}{red}{\makebox[2cm][r]{\textcolor{white}{\bfseries#1}}}%
}
\renewcommand\rightmark{The Red List of Vascular Plants of Taiwan, 2017}
\renewcommand\leftmark{2017 臺灣維管束植物紅皮書名錄}
\makeoddhead{memoirStylePages}{}{}{\footnotesize\leftmark~\frameboxl{\footnotesize\thepage}}
\makeevenhead{memoirStylePages}{\frameboxr{\footnotesize\thepage}~\footnotesize\rightmark}{}{}
\makeoddhead{chapter}{}{}{\footnotesize\leftmark~\frameboxl{\footnotesize\thepage}}
\makeevenhead{chapter}{\frameboxr{\footnotesize\thepage}~\footnotesize\rightmark}{}{}
% %\makeheadrule{memoirStylePages}{\textwidth}{\normalrulethickness}
\makeevenfoot{memoirStylePages}{}{}{}
\makeoddfoot{memoirStylePages}{}{}{}
\makepsmarks{memoirStylePages}{%
       \createmark{chapter}{left}{nonumber}{}{}
}

%%%%% </HEADER> %%%%%

%%%%% <INDEX> %%%%%
\usepackage{makeidx}
\makeatletter
\renewenvironment{theindex}
  {\if@twocolumn
      \@restonecolfalse
   \else
      \@restonecoltrue
   \fi
   \setlength{\columnseprule}{0pt}
   \setlength{\columnsep}{20pt}
   \begin{multicols}{4}[\section*{\indexname}]
   \markboth{\MakeUppercase\indexname}%
            {\MakeUppercase\indexname}%
   \thispagestyle{plain}
   \setlength{\parindent}{0pt}
   \setlength{\parskip}{0pt minus 2pt}
   \relax
   \let\item\@idxitem}%
  {\end{multicols}\if@restonecol\onecolumn\else\clearpage\fi}
\makeatother

\makeindex
%\makeindex[name=zh,title={中名索引}]

\setlist{leftmargin=0.3cm,itemindent=-0.2cm,labelwidth=0.1cm,labelsep=0.05cm,align=left,rightmargin=0.05cm}
% trim and bleed
\setstocksize{297mm}{210mm}
\setlrmarginsandblock{25mm}{25mm}{*}
\setulmarginsandblock{20mm}{25mm}{*}
%\setulmarginsandblock{25mm}{25mm}{*}
%\settrimmedsize{0.99\stockheight}{0.99\stockwidth}{*}
\checkandfixthelayout

\setheadfoot{\onelineskip}{\onelineskip}
%\setheadfoot{2pt}{8mm}
\setheaderspaces{*}{\onelineskip}{*}
\checkandfixthelayout
\quarkmarks

% add dictionary-like entry
\newcommand\entry[3][]{\small \noindent\textsf{\textbf{#2}}\ 
        #3\ifx\relax#1\relax\markboth{#2}{#2}\else\markboth{#1}{#1}\fi
        \par}\nopagebreak[4]

%\usepackage{atbegshi}
%\AtBeginShipout{\special{pdf: put @thispage <</TrimBox [30.0 30.0 500 600]>>}}
%\special{pdf: put @thispage <</TrimBox [30.0 30.0 500 600]>>}

\setcounter{tocdepth}{3}
\setcounter{secnumdepth}{3}

% rename 
\usepackage{titlesec}
\titleformat{\chapter}{\normalfont\huge}{\thechapter.}{20pt}{\huge}
\usepackage{titletoc}
\renewcommand{\contentsname}{\Kai{目\hspace{2em}錄}}
\renewcommand\indexname{\Kai{學名索引}}
\renewcommand\tablename{\color{red}{\Kai{表}}}
\renewcommand\thetable{\arabic{chapter}.\arabic{table}}
\renewcommand\figurename{\color{red}{\Kai{圖}}}
%\renewcommand\thefigure{\arabic{chapter}.\arabic{figure}}
\renewcommand\appendixname{附\hspace{2em}錄}
%\renewcommand*\contentsname{Table of Contents}
\renewcommand{\bibname}{參考文獻}
\renewcommand\bibsection{\chapter*{\refname}}

\renewcommand{\labelenumi}{\arabic{enumi}.}
\renewcommand{\labelenumii}{\arabic{enumi}.\arabic{enumii}}
\renewcommand{\labelenumiii}{\arabic{enumi}.\arabic{enumii}.\arabic{enumiii}}
\renewcommand{\labelenumiv}{\arabic{enumi}.\arabic{enumii}.\arabic{enumiii}.\arabic{enumiv}}


%% No hyphenation
%\hyphenchar\font=-1
\exhyphenpenalty=100000
\hyphenpenalty=100000

\titleformat*{\chapter}{\normalfont\huge\Kai\color{red}}
\titleformat*{\section}{\normalfont\Large\Kai\color{red}}
\usepackage{tabu}
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}}

\pagestyle{memoirStylePages}
\begin{document}
    \taburulecolor{red}
    % no break words
    \begin{Kai}
        \include{titlepage}
        \pagenumbering{roman}
        \tableofcontents
        \cleardoublepage
        \pagenumbering{arabic}
        \setcounter{page}{1}
        \include{ch0_abstract}
        \linespread{1.5}\selectfont
        \include{ch1_intro}
        \include{ch2_assessment}
    \end{Kai}
    \include{ch3_redlist}
    \large\selectfont
    \linespread{1}\selectfont
    \begin{Kai}
        \normalsize\selectfont
        \include{ch5_acknowledgement}
        \normalsize\selectfont
        \linespread{1}\selectfont
        \input{ch6_references}
        \addcontentsline{toc}{chapter}{參考文獻}
    \end{Kai}
    \cleardoublepage
    \phantomsection
    \chapter*{索引}
    \pagestyle{memoirStylePages}
    \addcontentsline{toc}{chapter}{\indexname}
    \begin{footnotesize}
    \pagestyle{memoirStylePages}
    因篇幅關係，學名索引中僅列出種及種下單位之學名不含作者，粗體字為受脅物種(CR、EN 以及 VU)。
    括號內的學名代表該分類群在本名錄中所接受的學名(中名索引亦同)。\\
    例如：\\
    
    \textit{Adenia formosana} (= \textit{Adenia heterophylla}) \\
    
    \noindent 其中 \textit{Adenia heterophylla} 為本名錄中所接受的學名，而 \textit{Adenia formosana} 
    為同物異名(包含鑑定錯誤、非法、無效以及不同分類觀念下之學名)
    \linespread{1.1}\selectfont
        \begin{flushleft}
            \printindex
        \end{flushleft}
    \end{footnotesize}
    \normalsize\selectfont
    \begin{Kai}
    \input{copyright}
    \end{Kai}
\end{document}
