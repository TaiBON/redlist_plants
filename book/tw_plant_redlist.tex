\documentclass[11pt,a4paper]{memoir}

%%%% GENERAL PACKAGES FORMATTING %%%%%

\usepackage[bookmarks, pdfauthor={臺灣植物紅皮書編輯委員會}, pdftitle={2017 臺灣維管束植物紅皮書名錄}]{hyperref}
\usepackage{amsmath,amsthm,amssymb} % for mathematical fonts
\usepackage{bold-extra}
\usepackage{caption}
\usepackage{doi}
\usepackage{enumitem}
\usepackage{epstopdf}   % figure eps to pdf
\usepackage{float}      % floating environment
\usepackage{graphicx}
\usepackage{natbib}     % for bibliography style%\usepackage{apalike}
\usepackage{apalike} % apalike
\usepackage{longtable}  % small capital
\usepackage{libertine}
% multi column & row
\usepackage{multicol}
\usepackage{multirow}
\usepackage{footnote}
\usepackage{setspace} 
\usepackage{pdfpages} % pdfpage
\usepackage{xcolor}
\usepackage{color}
\usepackage{xparse} % raise rules
\usepackage{afterpage}
\usepackage{pagecolor} % for titlepage
\usepackage{tcolorbox} % use for abstract boundary box 

%%%%% <XETEX> %%%%%
\usepackage{fontspec}
\usepackage{xeCJK}
\setCJKmainfont{Songti TC}
\newCJKfontfamily\Kai{Noto Sans T Chinese Light}
\newCJKfontfamily\Song{Songti TC Bold}
\newCJKfontfamily\Hangul{Batang}
\newCJKfontfamily\Kana{YuMincho}
\XeTeXlinebreaklocale "zh"
\XeTeXlinebreakskip = 0pt plus 1pt
\setlength{\parskip}{0.3cm}
\setmonofont[WordSpace={0.7,0.0,0.0}]{Courier}
\usepackage{xltxtra}
\renewcommand{\thepage}{\footnotesize{\arabic{page}}}
\linespread{1.2}\selectfont % 字型間距
\setlength\columnsep{18pt} % 兩欄之間的空隙
%%%%% </XETEX> %%%%%

%%%%% HEADER STYLE %%%%%%
\copypagestyle{memoirStylePages}{headings}
\nouppercaseheads
\copypagestyle{memoirStylePages}{headings}
\copypagestyle{chapter}{headings}
\copypagestyle{chapter*}{headings}
\copypagestyle{abstract}{headings}
\setlength{\headwidth}{\stockwidth+5em}
\makerunningwidth{memoirStylePages}{\headwidth}
\definecolor{mydarkgrey}{RGB}{89,87,88}
\definecolor{mylightgrey}{RGB}{220,221,221}
\definecolor{myred}{RGB}{230,0,18}
\definecolor{mylightred}{RGB}{251,218,200}
\definecolor{myorange}{RGB}{243,151,0}
\definecolor{mylightorange}{RGB}{255,236,210}
\definecolor{myyellow}{RGB}{255,226,0}
\definecolor{mylightyellow}{RGB}{255,250,222}
\definecolor{mygreen}{RGB}{219,224,0}
\definecolor{mylightgreen}{RGB}{249,249,218}

\newcommand\frameboxl[1]{%
  \fcolorbox{red}{red}{\makebox[2cm][l]{\textcolor{white}{\bfseries#1}}}%
  \hspace*{-1.5cm}
}
\newcommand\frameboxr[1]{%
  \hspace*{-1.5cm}
  \fcolorbox{red}{red}{\makebox[2cm][r]{\textcolor{white}{\bfseries#1}}}%
}
\newcommand\frameboxchpl[1]{%
  \fcolorbox{red}{red}{\makebox[2cm][l]{\textcolor{white}{\bfseries#1}}}%
  \hspace*{-2.6cm}
}
\newcommand\frameboxchpr[1]{%
  \hspace*{-2.6cm}
  \fcolorbox{red}{red}{\makebox[2cm][r]{\textcolor{red}{\bfseries#1}}}%
}
\newcommand\frameboxabstractl[1]{%
  \fcolorbox{white}{white}{\makebox[2cm][l]{\textcolor{red}{\bfseries#1}}}%
  \hspace*{-2.6cm}
}
\newcommand\frameboxabstractr[1]{%
  \hspace*{-2.6cm}
  \fcolorbox{white}{white}{\makebox[2cm][r]{\textcolor{red}{\bfseries#1}}}%
}

\renewcommand\rightmark{The Red List of Vascular Plants of Taiwan, 2017}
\renewcommand\leftmark{2017 臺灣維管束植物紅皮書名錄}
\makeoddhead{memoirStylePages}{}{}{\footnotesize\leftmark~\frameboxl{\footnotesize\thepage}}
\makeevenhead{memoirStylePages}{\frameboxr{\footnotesize\thepage}~\footnotesize\rightmark}{}{}
\makeoddhead{chapter}{}{}{\footnotesize\leftmark~\frameboxchpl{\footnotesize\thepage}}
\makeoddhead{chapter*}{}{}{\footnotesize\leftmark~\frameboxchpl{\footnotesize\thepage}}
\makeoddhead{abstract}{}{}{\footnotesize{\textcolor{white}{\leftmark}}~\frameboxabstractl{\footnotesize\thepage}}
\makeevenhead{abstract}{\frameboxabstractr{\footnotesize\thepage}~\footnotesize{\textcolor{white}{\leftmark}}}{}{}
\makeevenfoot{memoirStylePages}{}{}{}
\makeoddfoot{memoirStylePages}{}{}{}
%%%%% </HEADER> %%%%%

%%%%% <INDEX> %%%%%
\usepackage{makeidx}
\makeatletter
\renewenvironment{theindex}
  {\if@twocolumn
      \@restonecolfalse
   \else
      \@restonecoltrue
   \fi
   \setlength{\columnseprule}{0pt}
   \setlength{\columnsep}{22pt}
   \begin{multicols}{4}[\section*{\indexname}]
   \markboth{\MakeUppercase\indexname}%
            {\MakeUppercase\indexname}%
   %\thispagestyle{plain}
   \setlength{\parindent}{0pt}
   \setlength{\parskip}{0pt minus 2pt}
   \relax
   \let\item\@idxitem}%
  {\end{multicols}\if@restonecol\onecolumn\else\clearpage\fi}
\makeatother
\makeindex

% add dictionary-like entry
\newcommand\entry[3][]{\small \noindent\textsf{\textbf{#2}}\ 
        #3\ifx\relax#1\relax\markboth{#2}{#2}\else\markboth{#1}{#1}\fi
        \par}\nopagebreak[4]


%%%%% </INDEX> %%%%%

\setlist{leftmargin=0.3cm,itemindent=-0.2cm,labelwidth=0.1cm,labelsep=0.05cm,align=left,rightmargin=0.05cm}
% trim and bleed
\setstocksize{297mm}{210mm}
\setlrmarginsandblock{25mm}{25mm}{*}
\setulmarginsandblock{20mm}{25mm}{*}
%\setulmarginsandblock{25mm}{25mm}{*}
\checkandfixthelayout

\setheadfoot{\onelineskip}{\onelineskip}
\setheaderspaces{*}{\onelineskip}{*}
\checkandfixthelayout
\quarkmarks


\setcounter{tocdepth}{3}
\setcounter{secnumdepth}{3}

% rename 
\usepackage{titlesec}
\titleformat{\chapter}{\normalfont\huge}{\thechapter.}{20pt}{\huge}
\usepackage{titletoc}
\renewcommand{\contentsname}{目\hspace{2em}錄}
\renewcommand\indexname{學名索引}
\renewcommand\tablename{\color{red}{\Kai{表}}}
\renewcommand\thetable{\arabic{chapter}.\arabic{table}}
\renewcommand\figurename{\color{red}{\Kai{圖}}}
\renewcommand\appendixname{附\hspace{2em}錄}
%\renewcommand{\bibname}{6. 參考文獻}
\renewcommand{\bibname}{6.~~參考文獻}

\renewcommand{\labelenumi}{\arabic{enumi}.}
\renewcommand{\labelenumii}{\arabic{enumi}.\arabic{enumii}}
\renewcommand{\labelenumiii}{\arabic{enumi}.\arabic{enumii}.\arabic{enumiii}}
\renewcommand{\labelenumiv}{\arabic{enumi}.\arabic{enumii}.\arabic{enumiii}.\arabic{enumiv}}


%% No hyphenation
\exhyphenpenalty=9999
\hyphenpenalty=9999

\titleformat*{\chapter}{\normalfont\huge\Kai\color{red}}
\titleformat*{\section}{\normalfont\Large\Kai\color{red}}
\usepackage{tabu}
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}}

% https://tex.stackexchange.com/questions/21764/including-a-pseudo-chapter-in-the-table-of-contents
% it's necessary to add this for hyperref
\providecommand\phantomsection{}


\pagestyle{memoirStylePages}
\begin{document}
    \taburulecolor{red}
    % no break words
    \begin{Kai}
        \include{titlepage}
    \end{Kai}
        \pagenumbering{roman}
        \noindent\begin{minipage}[c]{\textwidth}
        \tableofcontents
        %\end{minipage}
        %\begin{minipage}[c]{0.4\textwidth}
        \vspace{0.5in}
        \footnotesize\linespread{1.0}\selectfont
        封面照片/\\
        {\mbox{\color{red}\rule[-0.5mm]{1mm}{0.34cm}~~}}\textit{Rhododendron farrerae} Sweet \\
        丁香杜鵑~~NT~張和明/攝 \\
        \normalsize\selectfont
        \end{minipage}
        \cleardoublepage
        \pagenumbering{arabic}
        \setcounter{page}{1}
        \include{ch0_abstract}
        \include{ch0_abstract_en}
        \linespread{1.5}\selectfont
        \include{ch1_intro}
        \include{ch2_assessment}
    \include{ch3_redlist}
    \large\selectfont
    \linespread{1}\selectfont
    \normalsize\selectfont
    \include{ch5_acknowledgement}
    \normalsize\selectfont
    \linespread{1}\selectfont
    \input{ch6_references}
    \addcontentsline{toc}{chapter}{6~~~~參考文獻}
    \cleardoublepage
    \phantomsection
    \chapter*{索引}
    \pagestyle{memoirStylePages}
    \addcontentsline{toc}{chapter}{\indexname}
    \begin{footnotesize}
    \pagestyle{memoirStylePages}
    因篇幅關係，學名索引中僅列出種及種下單位之學名不含作者，粗體字為受脅物種(CR、EN 以及 VU)。
    括號內的學名代表該分類群在本名錄中所接受的學名(中名索引亦同)。\\
    例如：\\
    
    \textit{Adenia formosana} (= \textit{Adenia heterophylla}) \\
    
    \noindent 其中 \textit{Adenia heterophylla} 為本名錄中所接受的學名，而 \textit{Adenia formosana} 
    為同物異名(包含鑑定錯誤、非法、無效以及不同分類觀念下之學名)
    \linespread{1.1}\selectfont
        \begin{flushleft}
            \printindex
        \end{flushleft}
    \end{footnotesize}
    \normalsize\selectfont
    \input{copyright}
\end{document}
